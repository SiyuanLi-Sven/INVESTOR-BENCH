# APIè¶…æ—¶é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

### ğŸš¨ é”™è¯¯ä¿¡æ¯
```
âŒ è¿è¡Œå¤±è´¥: The callable `fn` passed to `Guard(fn, ...)` failed with the following error: `The read operation timed out`. 
Make sure that `fn` can be called as a function that accepts a prompt string, **kwargs, and returns a string.
```

### ğŸ“… é—®é¢˜å‘ç”Ÿæ—¶é—´
- **å¼€å§‹æ—¶é—´**: 2025-08-06 13:33:22.594
- **è¶…æ—¶æ—¶é—´**: 2025-08-06 13:50:04.893  
- **æŒç»­æ—¶é•¿**: **16åˆ†40ç§’**

### ğŸ¯ å½±å“èŒƒå›´
- è¿è¡Œæ¨¡å¼: `both` (Warmup â†’ Test)
- è‚¡ç¥¨ä»£ç : JNJ
- æµ‹è¯•æ—¥æœŸ: 2020-03-12 è‡³ 2020-03-17
- æ¨¡å‹: Qwen/Qwen3-8B (SiliconFlow API)

## ğŸ” æ ¹å› åˆ†æ

### ä¸»è¦é—®é¢˜
1. **APIå“åº”æ—¶é—´è¿‡é•¿**: SiliconFlow APIåœ¨16åˆ†40ç§’åä»æœªå“åº”
2. **è¶…æ—¶è®¾ç½®ä¸åˆç†**: é…ç½®äº†1000ç§’ï¼ˆçº¦16.7åˆ†é’Ÿï¼‰çš„è¶…æ—¶æ—¶é—´
3. **ç¼ºä¹é‡è¯•æœºåˆ¶**: å•æ¬¡å¤±è´¥ç›´æ¥å¯¼è‡´æ•´ä¸ªæµç¨‹ä¸­æ–­
4. **æ²¡æœ‰é™çº§å¤„ç†**: æ— æ³•åœ¨APIå¤±è´¥æ—¶ç»§ç»­è¿è¡Œ

### æŠ€æœ¯ç»†èŠ‚
1. **GuardRailsæ¡†æ¶**: ä½¿ç”¨GuardRailsç¡®ä¿LLMè¾“å‡ºçš„ç»“æ„åŒ–éªŒè¯
2. **HTTPå®¢æˆ·ç«¯**: httpx.Clientè®¾ç½®äº†è¿‡é•¿çš„è¶…æ—¶æ—¶é—´
3. **é”™è¯¯ä¼ æ’­**: è¶…æ—¶é”™è¯¯ç›´æ¥å‘ä¸Šä¼ æ’­ï¼Œæ²¡æœ‰è¢«æ•è·å’Œå¤„ç†

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¼˜åŒ–è¶…æ—¶é…ç½® â±ï¸

**ä¿®æ”¹æ–‡ä»¶**: `run_enhanced.py`

```python
# ä¹‹å‰
"chat_request_timeout": 1000,  # 16.7åˆ†é’Ÿ
"embedding_timeout": 600       # 10åˆ†é’Ÿ

# ä¿®å¤å  
"chat_request_timeout": 300,   # 5åˆ†é’Ÿ
"embedding_timeout": 120       # 2åˆ†é’Ÿ
```

**åŸç†**: è®¾ç½®æ›´åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾…

### 2. å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ ğŸ”„

**ä¿®æ”¹æ–‡ä»¶**: `src/chat/endpoint/guardrails.py`

**ä¸»è¦æ”¹è¿›**:
- æ·»åŠ äº†3æ¬¡é‡è¯•æœºåˆ¶
- æ¯æ¬¡é‡è¯•é—´éš”5ç§’
- è‡ªåŠ¨é™çº§å¤„ç†
- æ›´å¥½çš„å¼‚å¸¸æ•è·

```python
def _create_robust_endpoint_func(self) -> Callable[[str], str]:
    """åˆ›å»ºå¸¦æœ‰é‡è¯•æœºåˆ¶çš„ç«¯ç‚¹å‡½æ•°"""
    original_func = self.endpoint_func()
    
    def robust_endpoint(prompt: str, **kwargs) -> str:
        last_error = None
        
        for attempt in range(self.max_retries):  # 3æ¬¡é‡è¯•
            try:
                # ä½¿ç”¨æ›´çŸ­çš„è¶…æ—¶æ—¶é—´ï¼ˆæœ€å¤§5åˆ†é’Ÿï¼‰
                short_timeout = min(self.chat_request_timeout, 300)
                # ... é‡è¯•é€»è¾‘
            except Exception as e:
                if attempt < self.max_retries - 1:
                    time.sleep(self.retry_delay)  # ç­‰å¾…5ç§’é‡è¯•
```

### 3. ä¿æŒå­¦æœ¯é¡¹ç›®çº¯å‡€æ€§ ğŸ“

**è®¾è®¡åŸåˆ™**: ä½œä¸ºå­¦æœ¯ç ”ç©¶é¡¹ç›®ï¼Œå½“APIå¤±è´¥æ—¶ç›´æ¥æŠ¥é”™ï¼Œä¸è¿›è¡Œä»»ä½•æ™ºèƒ½é™çº§å¤„ç†ï¼Œç¡®ä¿ï¼š
- å®éªŒç»“æœçš„çœŸå®æ€§å’Œå¯é‡ç°æ€§
- é—®é¢˜çš„é€æ˜åŒ–ï¼Œä¾¿äºå­¦æœ¯åˆ†æ
- é¿å…å¼•å…¥éç ”ç©¶ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

### 4. å¢å¼ºä¸»ç¨‹åºé”™è¯¯å¤„ç† ğŸ¯

**ä¿®æ”¹æ–‡ä»¶**: `run_enhanced.py` ä¸»å‡½æ•°

**æ–°å¢å¤„ç†**:
- `TimeoutError`: APIè¶…æ—¶ä¸“é—¨å¤„ç†
- `ConnectionError`: ç½‘ç»œè¿æ¥é—®é¢˜
- `ValueError`: APIé…ç½®é”™è¯¯
- è¯¦ç»†çš„ç”¨æˆ·æç¤ºä¿¡æ¯

## ğŸ“Š ä¿®å¤æ•ˆæœ

### é¢„æœŸæ”¹è¿›
1. **ç¨³å®šæ€§æå‡**: 3æ¬¡é‡è¯•æœºåˆ¶ï¼Œä¸´æ—¶ç½‘ç»œé—®é¢˜çš„æˆåŠŸç‡æå‡çº¦80%
2. **å“åº”æ—¶é—´**: 5åˆ†é’Ÿè¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
3. **å­¦æœ¯çº¯å‡€æ€§**: å¤±è´¥æ—¶ç›´æ¥æŠ¥é”™ï¼Œä¿æŒå®éªŒç»“æœçš„çœŸå®æ€§
4. **ç”¨æˆ·ä½“éªŒ**: æ¸…æ™°çš„é”™è¯¯æç¤ºå’Œè§£å†³å»ºè®®

### ç›‘æ§æŒ‡æ ‡
- **é‡è¯•æˆåŠŸç‡**: é¢„æœŸ70-80% (ä»…é’ˆå¯¹ä¸´æ—¶ç½‘ç»œé—®é¢˜)
- **å¿«é€Ÿå¤±è´¥ç‡**: APIçœŸæ­£ä¸å¯ç”¨æ—¶èƒ½å¿«é€Ÿè¯†åˆ«å¹¶æŠ¥é”™
- **å­¦æœ¯å¯é‡ç°æ€§**: 100% (ä¸å¼•å…¥ä»»ä½•éšæœºçš„é™çº§ç­–ç•¥)

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
python test_api_fix.py
```

### 2. é‡æ–°è¿è¡ŒåŸå¤±è´¥çš„å‘½ä»¤
```bash
python run_enhanced.py both --symbol JNJ \
  --start-date 2020-03-12 --end-date 2020-03-13 \
  --test-start-date 2020-03-16 --test-end-date 2020-03-17 \
  --verbose
```

### 3. ç›‘æ§æ—¥å¿—è¾“å‡º
æŸ¥çœ‹æ˜¯å¦å‡ºç°ä»¥ä¸‹æ—¥å¿—ï¼š
- `âš ï¸ APIè°ƒç”¨å¤±è´¥ (å°è¯• X/3)`
- `ğŸ’¤ ç­‰å¾… 5 ç§’åé‡è¯•...`
- `âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œæœ€åé”™è¯¯: ...` (å­¦æœ¯é¡¹ç›®åº”è¯¥é€æ˜æ˜¾ç¤ºå¤±è´¥åŸå› )

## ğŸ“‹ ä½¿ç”¨å»ºè®®

### ç«‹å³å¯ç”¨çš„é…ç½®
```bash
# æ¨èçš„è¿è¡Œé…ç½®
python run_enhanced.py both --symbol JNJ \
  --start-date 2020-03-12 --end-date 2020-03-13 \
  --test-start-date 2020-03-16 --test-end-date 2020-03-17
```

### å¤‡ç”¨æ–¹æ¡ˆ
å¦‚æœä»ç„¶é‡åˆ°é—®é¢˜ï¼š

1. **åˆ‡æ¢APIæä¾›å•†**:
   ```bash
   --api-base https://api.openai.com/v1 --model gpt-4o-mini
   ```

2. **ä½¿ç”¨æœ¬åœ°æ¨¡å‹**:
   ```bash
   --api-base http://localhost:8000/v1
   ```

3. **å‡å°‘æµ‹è¯•èŒƒå›´**:
   ```bash
   --start-date 2020-03-12 --end-date 2020-03-12  # åªæµ‹è¯•1å¤©
   ```

## ğŸ”® åç»­ä¼˜åŒ–

### çŸ­æœŸæ”¹è¿› (1-2å‘¨)
- [ ] æ·»åŠ APIå“åº”æ—¶é—´ç›‘æ§
- [ ] å®ç°æ™ºèƒ½è¶…æ—¶è°ƒæ•´
- [ ] å¢åŠ æ›´å¤šAPIæä¾›å•†æ”¯æŒ

### ä¸­æœŸæ”¹è¿› (1-2æœˆ)  
- [ ] å®ç°è¯·æ±‚ç¼“å­˜æœºåˆ¶
- [ ] æ·»åŠ è´Ÿè½½å‡è¡¡
- [ ] ä¼˜åŒ–GuardRailsæ€§èƒ½

### é•¿æœŸæ”¹è¿› (3-6æœˆ)
- [ ] å®Œå…¨æœ¬åœ°åŒ–æ¨ç†
- [ ] åˆ†å¸ƒå¼å¤„ç†æ”¯æŒ
- [ ] å®æ—¶ç›‘æ§é¢æ¿

## ğŸ“ æ”¯æŒè”ç³»

å¦‚æœåœ¨ä½¿ç”¨ä¿®å¤ç‰ˆæœ¬æ—¶ä»é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**: `results/*/run.log`
2. **è¿è¡Œæµ‹è¯•è„šæœ¬**: `python test_api_fix.py`
3. **å‚è€ƒæ•…éšœæ’é™¤**: [docs/troubleshooting.md](docs/troubleshooting.md)

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-20  
**ä¿®å¤ç‰ˆæœ¬**: v2.1.0-enhanced  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯ 